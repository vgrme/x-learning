<link rel="import" href="../../components/iron-ajax/iron-ajax.html">
<script src="../../components/async/lib/async.js"></script>

<dom-module id="api-s3-upload">
  <template>

    <iron-ajax id="createPart" method="GET" url="{{url}}" params="{{params}}"
      last-response="{{response_get}}" on-response="on_response_get">
    </iron-ajax>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'api-s3-upload',

    properties: {
      file: {
        type: Object
      },
      fileSize:{
        type : Number
      },
      collection: {
        type: String
      },
      folder: {
        type: String,
        value: ''
      },
      fileName: {
        type: String
      },
      response: {
        type: Object,
        notify: true
      },
      error: {
        type: Object,
        notify: true
      }
    },

    send: function (file) {
      if (file) {
        this.file = file;
        this.file_size = file.size;
      }
      if (!this.file) {
        return;
      }
      this._compute_url('create_multiPart_upload');
      this._compute_params();
      this.$.createPart.generateRequest();
    },
    
    _compute_url: function (value) {
      var url = '/api/' + this.collection + '/'+ value;
      url = url.replace(/\/\/+/, '/');
      this.url = url;
    },
    
    _compute_params: function () {
      var params = {};
      params.file_name = this.file.name;
      params.file_type = this.file.type;
      this.params = params;
    },

    get_signed_url: function (options, callback) {
      var ajax = document.createElement('iron-ajax');

      ajax.url = '/api/' + this.collection + '/signed_upload_part';
      ajax.method = 'GET';
      ajax.params = options;

      ajax.addEventListener('response', function (event) {
        callback(null, ajax.lastResponse);
      });

      ajax.addEventListener('error', function (event) {
        callback(ajax.lastError, null);
      });

      ajax.generateRequest();
    },

    upload_part: function (url, options, callback) {

      var ajax = document.createElement('iron-ajax');

      ajax.url = url;
      ajax.method = 'PUT';
      ajax.body = options.Body;

      ajax.addEventListener('response', function (event) {

            var xhr = event.detail.xhr;
            var etag = xhr.getResponseHeader('ETag');

            var response = { etag: etag };

            callback(null, response);
        });

        ajax.addEventListener('error', function (event) {
          callback(ajax.lastError, null);
        });
      ajax.generateRequest();   

    },

    complete_upload: function (options, callback){
      
      var ajax = document.createElement('iron-ajax');
      this._compute_url('complete_upload_part');
      ajax.url = this.url;
      ajax.method = 'PUT';
      ajax.body = options;
      ajax.contentType = 'application/json';
      ajax.handleAs = 'json';
      
      ajax.addEventListener('response', function (event) {
        callback(null, ajax.lastResponse);
      });

      ajax.addEventListener('error', function (event) {
        callback(ajax.lastError, null);
      });

      ajax.generateRequest();      

    },

    on_response_get: function (event) {

      //Upload
      var partNum = 0;
      var partSize = 1024 * 1024 * 5;
      
      var chunks = [];
      var multipartMap = {
        Parts: []
      };

      var fileName = this.file.name;
      var uploadId = this.response_get.dataId.UploadId;

      //creo chunks
      for (var rangeStart = 0; rangeStart < this.file_size; rangeStart += partSize) {
        partNum++;
        var end = Math.min(rangeStart + partSize, this.file_size);
       
        chunk = {
          chunk_file: this.file.slice(rangeStart, end),
          file_name: fileName,
          partNum: partNum,
          uploadId: uploadId
        }        
        chunks.push(chunk)
      }

      async.eachSeries(chunks, function (chunk, done) {
        var options = {
          Key: fileName,
          PartNumber: chunk.partNum,
          UploadId: uploadId,
        };

        //CHIEDO URL PER UPLOAD PART
        this.get_signed_url(options, function (err, data) {
          var signed_url = data.signed_url;

          var options_part = {
            Key: fileName,
            PartNumber: chunk.partNum,
            UploadId: uploadId,
            Body: chunk.chunk_file
          };

          //LANCIO UPLOAD PART 
          this.upload_part(signed_url, options_part, function (err, data) {
            if (err){
              console.log('multiErr, upload part error:', err);
              return;
            }

            var etag = data.etag.split('"')[1];
              multipartMap.Parts.push({
              ETag: etag,
              PartNumber: options_part.PartNumber
            
            });
            //dai l'ok
            async.setImmediate(done);
            
          }.bind(this));

        }.bind(this));

      }.bind(this), function (err) {

        var options_part = {
          Key: fileName,
          UploadId: uploadId,
          Parts: multipartMap.Parts
        };        
     
          this.complete_upload(options_part, function (err) {
            if(err){
              console.log(err)
            }

          });

      }.bind(this));
      
    }

  });

</script>