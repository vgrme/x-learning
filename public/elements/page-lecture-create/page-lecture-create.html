<link rel="import" href="../../components/api-model/api-model.html">
<link rel="import" href="../../components/api-user/api-user.html">
<link rel="import" href="../part-jumbotron/part-jumbotron.html">
<link rel="import" href="../style-page/style-page.html">
<link rel="import" href="form-lecture-create.html">
<link rel="import" href="../deck-upload-image/input-s3.html">
<link rel="import" href="../deck-upload-video/input-video-s3.html">
<link rel="import" href="part-lecture-create-save.html">


<dom-module id="page-lecture-create">
  <template>
    <style include="style-page"></style>
      
    <iron-ajax id="ajax_put_course_lecture" method="POST" 
     content-type="application/json" on-error="on_error" on-response="on_response"
     last-response="{{lecture}}">
    </iron-ajax> 

    <iron-ajax id="ajax_put_video_lecture" method="POST" 
     content-type="application/json">
    </iron-ajax> 

    <iron-ajax id="ajax_put_course_image" method="PUT" 
     content-type="application/json">
    </iron-ajax> 

    <layout-client>
      <part-jumbotron class="jumbotron">
       <h1>Create lecture</h1>
      </part-jumbotron>
      <div class="container">
        <part-lecture-create-save on-try-save-lecture="on_try_save_lecture"></part-lecture-create-save>

        <template is="dom-if" if="{{!data.course.cover}}">
          <h3>Insert course image</h3>
          <input-s3 collection="images" folder="image" on-response="on_upload"></input-s3>
          <button on-click="on_upload_image">Upload Image</button>
        </template>
        
        <h3>Insert lecture</h3>
        <form-lecture-create lecture="{{lecture}}"></form-lecture-create>
        
        <h3>Insert video</h3>
        <input-video-s3 collection="videos" folder="videos"
        response="{{video}}" error="{{error}}" on-upload-video="on_upload_video">
       </input-video-s3>
      </div>
    </layout-client>
      
  </template>
</dom-module>

<script>
  Polymer({

    is: 'page-lecture-create',

    properties: {
      lecture: {
        type: Object,
        value: function () { return {}; }
      },
      video: {
        type: Object,
        value: function () { return {}; }
      }
    },
   
    on_response: function(event){
      console.log(this.response)
      // this.video.url="http://d1s3yn3kxq96sy.cloudfront.net/bigbuckbunny/index.m3u8";
      this.$.ajax_put_video_lecture.url = '/api/lectures/' + this.lecture.id + '/video';
      this.$.ajax_put_video_lecture.body = JSON.stringify(this.video);
      this.$.ajax_put_video_lecture.generateRequest();
    },

    on_try_save_lecture:function(event){
      event.stopPropagation();
      this.$.ajax_put_course_lecture.url = '/api/courses/' + this.data.course.id + '/lectures';
      this.$.ajax_put_course_lecture.body = JSON.stringify(this.lecture);
      this.$.ajax_put_course_lecture.generateRequest();
    },
    on_upload_image:function(){
      this.$.ajax_put_course_image.url ='/api/courses';
      this.$.ajax_put_course_image.body = JSON.stringify(this.data.course);
      this.$.ajax_put_course_image.generateRequest();
    },
    on_upload_video:function(event){
      console.log(event.detail)
      this.video.url=event.detail;
      // this.data.course.cover=url;
    }

  });
</script>