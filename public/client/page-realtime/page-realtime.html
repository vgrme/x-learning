<link rel="import" href="../../components/app-link/app-link.html">
<link rel="import" href="../../components/iron-input/iron-input.html">
<link rel="import" href="../../components/iron-flex-layout/iron-flex-layout.html">
<script src="../../components/peerjs/peer.js"></script>
<dom-module id="page-realtime">
  <template>
    <style>
      :host {
        display: block;
      }

      video {
        width: 300px;
        height: auto;
      }

      #container {
        @apply(--layout-horizontal);
      }

      #videos {
        @apply(--layout-flex);
      }
      
      #actions {
        @apply(--layout-flex);
      }
    </style>
  
    <h2>Realtime</h2>   

    <div id="container">
      <div id="videos">
        <video src="{{my_stream}}" muted="true" autoplay></video>
      </div>

      <div id="actions">
        <!-- <template is="dom-if" if="{{error}}"> -->
          <p>Failed to access the webcam and microphone.</p>
          <button class="btn btn-warning" on-click="on_click_retry">retry call</button>
        <!-- </template> -->

        <!-- <template is="dom-if" if="{{step_2}}"> -->
          <p>Your id {{peer_id}}</p>
          <div class="pure-form">
            <input type="text" is="iron-input" bind-value="{{callto_id}}" placeholder="Call id">
            <button class="btn btn-success" on-click="on_click_begin">begin call</button>
          </div>
        <!-- </template> -->

        <div>
          <template id="others" is="dom-repeat" items="{{others}}" as="other">
            <p>Other id {{other.peer}}</p>
            <video src="{{other.stream}}" autoplay></video>
            <button class="btn btn-danger" on-click="on_click_end">end call</button>
          </template>
        </div>
    </div>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'page-realtime',

    properties: {
      others: {
        type: Array,
        value: function () { return []; }
      }
    },

    on_click_begin: function (event) {
      var call = this.peer.call(this.callto_id, this.local_stream);
    },

    on_click_end: function (event) {
      var other = this.$.others.itemForElement(event.target);
      other.close();
    },

    on_click_retry: function (event) {
      this.start();
    },

    attached: function () {
      navigator.getUserMedia = navigator.getUserMedia 
        || navigator.webkitGetUserMedia 
        || navigator.mozGetUserMedia;
   
      var peer = this.peer = new Peer({ key: '0auyh3o7cg2jra4i', debug: 3 });

      peer.on('open', this.on_open.bind(this));
      peer.on('call', this.on_call.bind(this));
      peer.on('error', this.on_error.bind(this));

      this.start();
    },

    start: function () {
      var self = this;

      navigator.getUserMedia({audio: true, video: true}, function (stream) {
        // Set your video displays
        self.my_stream = URL.createObjectURL(stream);
        self.local_stream = stream;
      }, function (error) { 
        console.error(error);
      });
    },

    on_open: function (id) {
      this.set('peer_id', this.peer.id); 
      console.log('open', this.peer.id, id);
    },

    on_call: function (call) {
      console.log('call', call, this.peer.id);

      var self = this;

      call.answer(self.local_stream);

      call.on('stream', function (stream) {
        console.log(call.peer, 'stream', stream)
        call.stream = URL.createObjectURL(stream);
        self.push('others', call);

        window.streams = {};
        window.streams[call.peer] = call.stream;
      });

      call.on('close', function () {
        var index = self.others.indexOf(call);
        self.splice('others', index, 1);
      });
    },

    on_error: function (error) {
      alert(error.message);
    }

  });
</script>