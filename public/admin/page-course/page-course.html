<link rel="import" href="../../components/api-user/api-user.html">
<link rel="import" href="../../components/app-link/app-link.html">
<link rel="import" href="../../components/app-session/app-session.html">
<link rel="import" href="../layout-admin/layout-admin.html">
<link rel="import" href="../../styles/style-panel/style-panel.html">
<link rel="import" href="../../styles/style-button/style-button.html">
<link rel="import" href="../../styles/style-form/style-form.html">

<link rel="import" href="list-course-lectures.html">
<link rel="import" href="list-course-webinars.html">
<link rel="import" href="part-course-actions.html">
<link rel="import" href="part-course-header.html">
<link rel="import" href="part-course-info.html">
<link rel="import" href="part-course-image.html">
<link rel="import" href="part-course-aims.html">

<dom-module id="page-course">
  <template>
    <style include="style-panel"></style>
    
    <app-session id="session"></app-session>


    <iron-ajax id="ajax_put" method="POST" handle-as="json" content-type="application/json" last-response="{{course}}" on-response="on_response_create"> </iron-ajax>

    <api-model-update id="update" collection="courses" model-id="{{course.id}}"
      data="{{course}}" response="{{course}}" error="{{error}}" on-response="on_response_update">
    </api-model-update>

     <iron-ajax id="ajax_delete" method="DELETE"></iron-ajax>

    <layout-admin on-try-save="on_try_save" on-try-publish="on_try_publish"
      on-try-preview="on_try_preview" on-try-delete="on_try_delete">
        <h1>Course</h1>
        <part-course-header course="{{course}}"></part-course-header>
        <part-course-actions course="{{course}}"></part-course-actions>
        <part-course-info course="{{course}}" error="{{error}}"></part-course-info>
        <part-course-image course="{{course}}"></part-course-image>
        <part-course-aims course="{{course}}"></part-course-aims>

        <div class="panel">
          <a is="app-link" href="/admin/courses/{{course.id}}/lectures/new">ADD LECTURE</a>
          <h3>Lectures</h3>
          <list-course-lectures course="{{course}}" on-try-delete-lecture="on_try_delete_lecture"></list-course-lectures>
        </div>
        <div class="panel">
          <a is="app-link" href="/admin/courses/{{course.id}}/webinar/new">ADD WEBINAR</a>
          <h3>Webinars</h3>
          <list-course-webinars course="{{course}}" on-try-delete-webinar="on_try_delete_webinar"></list-course-webinars>
      </div>
    </layout-admin>

  </template>
</dom-module>
<script>
  Polymer({

    is: 'page-course',

    properties: {
      data: {
        type: Object,
        value: function () { return {}; }
      },
      aims: {
        type: Object,
        value: function () { return {}; }
      },
    },

    attached:function(){
      this.course = this.data.course;
      if(!this.course.publish)
        this.course.publish=false;
    },

    on_try_save: function (event) {
      event.stopPropagation();
      if(this.course.id){
        this.$.update.send();
      }
      else{
        this.$.ajax_put.body=JSON.stringify(this.course);
        this.$.ajax_put.url='/api/members/'+ this.$.session.get('user').id +'/teaching';
        this.$.ajax_put.generateRequest();
      }
    },

    on_try_publish: function (event) {
      event.stopPropagation();
      if(this.course.id){
        this.course.publish = !this.course.publish;
        console.log(this.course)
        this.$.update.send();
      }
    },

    on_response_update: function (event) {
      event.stopPropagation();
      page('/admin/courses/' + this.course.id);
    },

    on_try_preview: function (event) {
      event.stopPropagation();
      page('/courses/' + this.course.id)
    },

    on_try_delete: function (event) {
      event.stopPropagation();
      this.$.ajax_delete.url='/api/courses/'+ this.course.id +'/follow';
      this.$.ajax_delete.generateRequest();
      this.$.ajax_delete.url='/api/courses/'+ this.course.id +'/lectures';
      this.$.ajax_delete.generateRequest();
      this.$.ajax_delete.url='/api/courses/'+ this.course.id ;
      this.$.ajax_delete.generateRequest();
      page('/admin/courses')
    },

    on_try_delete_lecture: function (event) {
      event.stopPropagation();
      this.$.ajax_delete.url='/api/lectures/'+ event.detail.id + '/video';
      this.$.ajax_delete.generateRequest();
      this.$.ajax_delete.url='/api/lectures/'+ event.detail.id;
      this.$.ajax_delete.generateRequest();
      page('/admin/courses/' + this.course.id);
    },

    on_try_delete_webinar: function (event) {
      event.stopPropagation();
      this.$.ajax_delete.url='/api/webinars/'+ event.detail.id;
      this.$.ajax_delete.generateRequest();
      page('/admin/courses/' + this.course.id);
    },

    on_response_create: function (event) {
      page('/admin/courses/'+ this.course.id)
    },

    on_response: function(event){
      var url = event.detail.split("?")[0];
      this.course.cover = url;
      console.log(this.course);

      if(this.course.id)
        this.on_try_save(event);
    }

  });
</script>